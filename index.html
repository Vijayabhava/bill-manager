<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Billing Invoice</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#16a34a">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  background:#f1f5f9;
  font-family:system-ui,Segoe UI;
}
.invoice-card{
  max-width:1100px;
  margin:auto;
  background:#fff;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
  padding:20px;
}
.amount{font-weight:700;color:#16a34a;}
.sticky-actions{
  position:sticky;
  bottom:0;
  background:#fff;
  padding:10px;
  border-top:1px solid #e5e7eb;
}
.app-footer{
  text-align:center;
  font-size:12px;
  color:#6b7280;
  margin-top:15px;
}

/* Autocomplete */
.autocomplete-box{
  position:absolute;
  background:#fff;
  border:1px solid #e5e7eb;
  width:100%;
  max-height:150px;
  overflow-y:auto;
  z-index:1000;
  border-radius:6px;
}
.autocomplete-item{
  padding:6px 10px;
  cursor:pointer;
}
.autocomplete-item:hover{
  background:#f1f5f9;
}

@media print{
  .no-print{display:none;}
}
</style>
</head>

<body class="p-2 p-md-4">

<div class="invoice-card">

<!-- HEADER -->
<div class="text-center mb-3">
  <h3>üßæ SMART BILLING INVOICE</h3>
  <small class="text-muted">Fast ‚Ä¢ Simple ‚Ä¢ Professional</small>
</div>

<!-- INFO -->
<div class="row g-2 mb-3">
  <div class="col-md-3">
    <label>Customer Name</label>
    <input id="customerName" class="form-control">
  </div>
  <div class="col-md-3">
    <label>Customer Phone</label>
    <input id="customerPhone" class="form-control" placeholder="Optional">
  </div>
  <div class="col-md-3">
    <label>Date</label>
    <input id="invoiceDate" class="form-control" readonly>
  </div>
  <div class="col-md-3">
    <label>Invoice No</label>
    <input id="invoiceNo" class="form-control" readonly>
  </div>
</div>

<!-- TABLE -->
<div class="table-responsive">
<table class="table table-bordered text-center align-middle">
<thead class="table-dark">
<tr>
<th>#</th><th>Product</th><th>MRP</th><th>Quantity</th><th>Amount</th>
</tr>
</thead>
<tbody id="billBody"></tbody>
</table>
</div>

<button class="btn btn-outline-primary w-100 mb-3 no-print" onclick="addRow()">‚ûï Add Product</button>

<!-- PAYMENT -->
<div class="row g-2">
  <div class="col-md-4">
    <div class="p-3 bg-light rounded">
      Total Amount<br>
      <b>‚Çπ <span id="totalAmount">0.00</span></b>
    </div>
  </div>
  <div class="col-md-4">
    <div class="p-3 bg-light rounded">
      Paid Amount
      <input id="paidAmount" type="number" class="form-control mt-1" oninput="calculateBalance()">
    </div>
  </div>
  <div class="col-md-4">
    <div class="p-3 bg-light rounded">
      Balance<br>
      <b id="balanceText">‚Çπ0</b>
    </div>
  </div>
</div>

<!-- ACTIONS -->
<div class="sticky-actions mt-3 no-print">
  <button class="btn btn-success w-100 mb-2" onclick="shareWhatsApp()">üì≤ Share on WhatsApp</button>
  <button class="btn btn-secondary w-100 mb-2" onclick="window.print()">üñ®Ô∏è Print Bill</button>
  <button class="btn btn-outline-dark w-100" onclick="downloadPDF()">‚¨áÔ∏è Download PDF</button>
</div>

<div class="app-footer">
  Made by <strong>Sumit Sharma</strong>
</div>

</div>

<script>
let rowCount = 0;
let invoiceNumber = "";
const STORAGE_KEY = "billing_product_master";

/* INIT */
(function(){
  const d = new Date();
  invoiceDate.value = d.toLocaleDateString("en-GB");
  invoiceNumber =
    `INV-${d.getFullYear()}${d.getMonth()+1}${d.getDate()}-${Math.floor(Math.random()*1000)}`;
  invoiceNo.value = invoiceNumber;
})();

/* PRODUCT MEMORY */
function getProductMaster(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
}
function saveProduct(name){
  if(!name) return;
  const list=getProductMaster();
  if(!list.includes(name)){
    list.push(name);
    localStorage.setItem(STORAGE_KEY,JSON.stringify(list));
  }
}

/* ADD ROW */
function addRow(){
  rowCount++;
  billBody.insertAdjacentHTML("beforeend",`
<tr>
<td>${rowCount}</td>
<td style="position:relative">
  <input class="form-control product-name"
    oninput="showSuggestions(this)"
    onchange="saveProduct(this.value.trim())">
  <div class="autocomplete-box d-none"></div>
</td>
<td><input type="number" class="form-control mrp" oninput="calc(this)"></td>
<td>
  <div class="d-flex gap-1">
    <select class="form-select unit" onchange="calc(this)">
      <option value="pcs">PCS</option>
      <option value="kg">KG</option>
      <option value="gm">GM</option>
    </select>
    <input type="number" class="form-control qty" oninput="calc(this)">
  </div>
</td>
<td class="amount">0.00</td>
</tr>`);
}

/* AUTOCOMPLETE */
function showSuggestions(input){
  const box=input.nextElementSibling;
  const val=input.value.toLowerCase();
  box.innerHTML="";
  if(!val){ box.classList.add("d-none"); return; }

  getProductMaster()
    .filter(p=>p.toLowerCase().startsWith(val))
    .forEach(p=>{
      const d=document.createElement("div");
      d.className="autocomplete-item";
      d.innerText=p;
      d.onmousedown=()=>{
        input.value=p;
        box.classList.add("d-none");
      };
      box.appendChild(d);
    });

  box.classList.toggle("d-none",box.children.length===0);
}

/* CALC */
function calc(el){
  const r=el.closest("tr");
  const mrp=+r.querySelector(".mrp").value||0;
  const qty=+r.querySelector(".qty").value||0;
  const unit=r.querySelector(".unit").value;
  r.querySelector(".amount").innerText=
    ((unit==="gm")?mrp*(qty/1000):mrp*qty).toFixed(2);
  total();
}

function total(){
  let t=0;
  document.querySelectorAll(".amount").forEach(a=>t+=+a.innerText);
  totalAmount.innerText=t.toFixed(2);
  calculateBalance();
}

function calculateBalance(){
  const diff=(+paidAmount.value||0)-(+totalAmount.innerText);
  balanceText.innerText=
    diff>0?`Return ‚Çπ${diff.toFixed(2)}`:
    diff<0?`Due ‚Çπ${Math.abs(diff).toFixed(2)}`:"‚Çπ0";
}

/* WHATSAPP */
function shareWhatsApp(){
  let msg=`üßæ BILL RECEIPT\nInvoice: ${invoiceNumber}\nCustomer: ${customerName.value}\n\n`;
  document.querySelectorAll("#billBody tr").forEach((r,i)=>{
    msg+=`${i+1}. ${r.querySelector(".product-name").value} - ‚Çπ${r.querySelector(".amount").innerText}\n`;
  });
  msg+=`\nTotal: ‚Çπ${totalAmount.innerText}\n${balanceText.innerText}\nThank you!`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,"_blank");
}

/* PDF */
function downloadPDF(){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  doc.text("BILLING INVOICE",105,15,{align:"center"});
  doc.text(`Invoice: ${invoiceNumber}`,14,30);
  let y=45;
  document.querySelectorAll("#billBody tr").forEach((r,i)=>{
    doc.text(`${i+1}. ${r.querySelector(".product-name").value} - ‚Çπ${r.querySelector(".amount").innerText}`,14,y);
    y+=8;
  });
  doc.text(`Total: ‚Çπ${totalAmount.innerText}`,14,y+10);
  doc.save(`Invoice-${invoiceNumber}.pdf`);
}

/* SERVICE WORKER */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("/service-worker.js");
}

addRow();
</script>
</body>
</html>
